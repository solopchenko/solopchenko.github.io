<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Внешний контент от поставщика</title>
  </head>
  <body>
    <h2>Внешний контент от поставщика</h2>
    <p>Контент поставщика</p>
    <p id="insertData"></p>

    <script>
      const generateStatus = () => {
        const statuses = ['loading', 'ready', 'error'];
        const taskStatuses = ['inProgress', 'failed', 'pendingResult', 'completed'];
        const responses = [
          {
            status: 'loading',
            taskStatus: 'inProgress',
            taskData: '',
          },
          {
            status: 'loading',
          },
          {
            status: 'ready',
            taskStatus: 'inProgress',
            taskData: 'task in progress',
          },
          {
            status: 'ready',
            taskStatus: 'failed',
            taskData: 'task failed',
          },
          {
            status: 'ready',
            taskStatus: 'pendingResult',
            taskData: 'task pending result',
          },
          {
            status: 'ready',
            taskStatus: 'completed',
            taskData: 'task completed',
          },
          {
            status: 'error',
            taskStatus: 'inProgress',
            taskData: 'task in progress',
          },
          {
            status: 'error',
          },
        ];

        return responses[Math.floor(Math.random() * 8)]
      };

      const listener = (event) => {
        console.log('Iframe received message: ', event);
        let message = null;
        try {
          message = JSON.parse(event.data);
        }
        catch (error) {
          console.warn(error);
        }
        switch (message.action) {
          case 'getStatus':
            const status = generateStatus();
            window.parent.postMessage(JSON.stringify(status), '*');
            break;
          case 'setData':
            document.getElementById('insertData').innerHTML = message.data;
            break;
          default:
            break;
        }
      }

      window.addEventListener("message", listener, false);

      window.parent.postMessage(generateStatus(), '*');
    </script>
  </body>
</html>
