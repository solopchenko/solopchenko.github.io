<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Внешний контент от поставщика</title>
  </head>
  <body>
    <h2>Внешний контент от поставщика</h2>
    <p>Контент поставщика</p>
    <button id="error-button">Ошибка</button>
    <button id="completed-button">Успешно выполнено</button>
    <button id="failed-button">Провалено</button>
    <p id="insertData"></p>

    <script>

      const generateStatus = () => {
        const responses = [
          {
            status: 'loading',
          },
          {
            status: 'error',
          },
          {
            status: 'ready',
            taskStatus: 'inProgress',
            taskData: 'task in progress',
          },
          {
            status: 'ready',
            taskStatus: 'failed',
            taskData: 'task failed',
          },
          {
            status: 'ready',
            taskStatus: 'pendingResult',
            taskData: 'task pending result',
          },
          {
            status: 'ready',
            taskStatus: 'completed',
            taskData: 'task completed',
          },
        ];
        const response = responses[Math.floor(Math.random() * 6)];
        return response;
      };

      const sendStatus = () => {
        const response = generateStatus();
        const url = new URL(window.location);
        const status = url.searchParams.get('status');
        const taskStatus = url.searchParams.get('taskStatus');
        const taskData = url.searchParams.get('taskData');
        if (status)
          response.status = status;
        if (taskStatus)
          response.taskStatus = taskStatus;
        if (taskData) 
          response.taskData = taskData;
        return response;
      }

      const listener = (event) => {
        console.log('Iframe received message: ', event);
        const message = event.data;
        switch (message.action) {
          case 'getStatus':
            const status = generateStatus();
            window.parent.postMessage(status, '*');
            break;
          case 'setData':
            document.getElementById('insertData').innerHTML = 'Received data: ' + (typeof message.data === "object") ? JSON.stringify(message.data) : message.data;
            break;
          default:
            break;
        }
      }

      window.addEventListener("message", listener, false);

      document.addEventListener('ready', () => {
        document.getElementById('error-button').addEventListener('click', () => window.parent.postMessage({ status: 'error' }, '*'));
        document.getElementById('completed-button').addEventListener('click', () => window.parent.postMessage({ status: 'ready', taskStatus: 'completed' }, '*'));
        document.getElementById('failed-button').addEventListener('click', () => window.parent.postMessage({ status: 'error', taskStatus: 'failed' }, '*'));
      });

      window.parent.postMessage(sendStatus(), '*');
    </script>
  </body>
</html>
